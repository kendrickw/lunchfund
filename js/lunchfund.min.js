var googleFormGETURL="https://spreadsheets.google.com/feeds/cells/0Av83aWCuOImRdDA5cFVBd2hlbnhvYnhkQmJMNUhHYXc/od7/public/basic?alt=json-in-script&callback=?";var googleFormPOSTURL="https://docs.google.com/forms/d/1hGfAw3GT5YbiTWlNqZhMBAsx2fJ6Jnt5mmhg_8VJLs0/formResponse";var googleAttendee="entry.598889479";var googleLunchFund="entry_1892695599";var googleFundHolder="entry.960282559";var googleSubmitter="entry_1745174688";var googleEventDate="entry_472715279";var submitter;var showSubmitter;var tipPercent=10;var billAmount=0;var amountToTip=0;var amountToPay=0;var eachPays=0;var lunchFundAmount=0;var namelist=[];var attendee=[];var attendeeChanged=false;var debugmode=false;function localStorageSetItem(name,value){"use strict";if(Modernizr.localstorage){localStorage.setItem(name,value);}}function localStorageGetItem(name){"use strict";if(Modernizr.localstorage){return localStorage.getItem(name);}else{return null;}}function getDate(){"use strict";var now=new Date();return now.getFullYear()+'-'+(now.getMonth()+1)+'-'+now.getDate();}function drawSubmissionFormChkBox(element){"use strict";var chkboxlist="",i=0,len=namelist.length;while(i<len){chkboxlist+='<input type="checkbox" style="display:none;"'+' name="SF_Names[]"'+' value="'+namelist[i]+'"'+' id="SF_Name'+i+'"/>\n';i+=1;}element.empty();element.append(chkboxlist);}function drawSelectMenu(selectelement,selectlist,selected){"use strict";var optionlist="<option value='' data-placeholder='true'>Choose one</option>\n",i=0,len=selectlist.length,name="";while(i<len){name=selectlist[i];optionlist+='<option value="'+name+'"';if(selected===name){optionlist+=' selected="selected"';}optionlist+='>'+name+'</option>\n';i+=1;}selectelement.empty();selectelement.append(optionlist);selectelement.selectmenu('refresh');}function drawParticipantText(){"use strict";var selected=attendee.slice(),num=selected.length,listverbosetext;if(num===0){listverbosetext="No Luncher";}else{listverbosetext=selected.join(", ");}$("#participantcounttext").text(num);$("#participantlisttext").text(listverbosetext);}function getLunchFundHolder(){"use strict";var fundholder=$('#fundholderselect').val();if(fundholder!==""){return fundholder;}else{return null;}}function getSubmitter(){"use strict";var submittername=$('#submitterselect').val();if(submittername!==""){return submittername;}else{return null;}}function getEventDate(){"use strict";var date=$('#eventdate').val();if(date===''){return getDate();}else{return date;}}function getEventLocation(){"use strict";return null;}function syncSubFormCheckboxes(){"use strict";var i=0,len=namelist.length,name="",input_idname="",input_elem;while(i<len){name=namelist[i];input_idname="SF_Name"+i;input_elem=$("#"+input_idname);if($.inArray(name,attendee)!==-1){input_elem.attr('checked','checked');}else{input_elem.removeAttr('checked');}i+=1;}}function syncSubFormBillAmount(){"use strict";$("#SF_BillAmount").attr('value',billAmount);}function syncSubFormTotalPaid(){"use strict";$("#SF_TotalPaid").attr('value',amountToPay);}function syncSubFormLunchFundAmount(){"use strict";$("#SF_LunchFund").attr('value',lunchFundAmount);}function syncSubFormWhoHoldsMoney(){"use strict";$("#SF_FundHolder").attr('value',getLunchFundHolder());}function syncSubFormSubmitterName(){"use strict";$("#SF_Submitter").attr('value',submitter);}function syncSubFormEventDate(){"use strict";$("#SF_EventDate").attr('value',getEventDate());}function syncSubFormEventLocation(){"use strict";$("#SF_EventLocation").attr('value',getEventLocation());}function syncSubmissionForm(){"use strict";if(attendee.length===0){alert("You must select at least one luncher.");return false;}if(billAmount<=0){alert("You must provide a non-zero bill amount.");return false;}if(getLunchFundHolder()===null){alert("You must select a lunch fund holder.");return false;}if(getSubmitter()===null){alert("You must select a submitter name.");return false;}syncSubFormCheckboxes();syncSubFormBillAmount();syncSubFormTotalPaid();syncSubFormLunchFundAmount();syncSubFormWhoHoldsMoney();syncSubFormSubmitterName();syncSubFormEventDate();syncSubFormEventLocation();return true;}function calculate_using_billAmount(billamount,numPerson){"use strict";var totalCollected;amountToPay=Math.ceil(billAmount*(1+tipPercent/100));amountToTip=amountToPay-billAmount;if(numPerson>0){eachPays=Math.ceil(amountToPay/numPerson);}else{eachPays=0;}totalCollected=eachPays*numPerson;lunchFundAmount=totalCollected-amountToPay;}function calculate_actual_tip_percentage(billamount,tipsamount){"use strict";if(billamount===0){return 0;}else{return(tipsamount/billamount*100).toFixed(2);}}function drawAllAmountsText(){"use strict";$("#tipspercenttext").text(calculate_actual_tip_percentage(billAmount,amountToTip));$("#tipstext1").text(amountToTip).formatCurrency();$("#tipstext2").text(amountToTip).formatCurrency();$("#mealtotaltext").text(amountToPay).formatCurrency();$("#eachpaystext1").text(eachPays).formatCurrency();$("#eachpaystext2").text(eachPays).formatCurrency();$("#lunchfundtext").text(lunchFundAmount).formatCurrency();}function formatMoney(val){"use strict";var regex=/[0-9]/,len=0;if(!regex.test(val[val.length-1])){val=val.slice(0,-1);}val=val.replace(".","");while(val.length>1){if(val[0]==='0'){val=val.substr(1);}else{break;}}if(val.length===0){val="0.00";}else if(val.length===1){val="0.0"+val;}else if(val.length===2){val="0."+val;}else{len=val.length;val=val.substr(0,len-2)+"."+val.substr(len-2);}return val;}function drawPieChart(inputnamelist,share){"use strict";$(function(){var piechart_data=[],count=inputnamelist.length,j=0,plot;piechart_data[count]={label:"Others",data:0};$.each(namelist,function(i,name){if($.inArray(name,inputnamelist)!==-1){piechart_data[j]={label:name,data:parseInt(share[name],10)};j+=1;}else{piechart_data[count].data+=parseInt(share[name],10);}});plot=$.plot($("#piechart1"),piechart_data,{series:{pie:{show:true,radius:1,label:{show:true,radius:3/4,formatter:function(label,series){return'<div style="font-size:8pt;text-align:center;padding:2px;color:black;">'+label+'<br/>'+Math.round(series.percent)+'%</div>';}}}},legend:{show:false}});});}function jsonReadGoogleSpreadsheet(callbackfunc){"use strict";$.mobile.loading('show');$.getJSON(googleFormGETURL,function(data){var owner_row=0,shares_row=0,bookvalue_row=0,marketvalue_row=0,totalshare_row=0,name_idx=0,cell,value,gnamelist=[],gshare={},gfund_bookvalue=0,gfund_marketvalue=0,gtotal_shares=0;$.each(data.feed.entry,function(i,entry){cell=entry.title.$t;value=entry.content.$t;if(cell==='B2'){gfund_bookvalue=value;}else if(cell==='D2'){gfund_marketvalue=value;}else if(cell==='B3'){gtotal_shares=value;}else if(cell[0]==='A'){if(owner_row===0&&value==='Owner'){owner_row=cell.substr(1);}else if(shares_row===0&&value==='Number of Shares'){shares_row=cell.substr(1);name_idx=0;}}else{if(cell.substr(1)===owner_row){gnamelist.push(value);}else if(cell.substr(1)===shares_row){gshare[gnamelist[name_idx]]=value;name_idx+=1;}}});localStorageSetItem('timeofstat',Date());gnamelist.sort(function(a,b){var a1=parseFloat(gshare[a]),b1=parseFloat(gshare[b]);if(a1===b1){return 0;}return a1<b1?1:-1;});localStorageSetItem('share',JSON.stringify(gshare));localStorageSetItem('fund_marketvalue',gfund_marketvalue);localStorageSetItem('fund_bookvalue',gfund_bookvalue);localStorageSetItem('total_shares',gtotal_shares);$.mobile.loading('hide');callbackfunc();});}function postFormToGoogle(){"use strict";var googleFormData=$('#submissionForm').serialize();googleFormData=googleFormData.replace(/SF_Names%5B%5D/g,googleAttendee);googleFormData=googleFormData.replace(/SF_LunchFund/,googleLunchFund);googleFormData=googleFormData.replace(/SF_FundHolder/,googleFundHolder);googleFormData=googleFormData.replace(/SF_Submitter/,googleSubmitter);googleFormData=googleFormData.replace(/SF_EventDate/,googleEventDate);$.post(googleFormPOSTURL,googleFormData,function(){}).fail(function(data){}).always(function(){});}function initAttendeeList(){"use strict";if(namelist.length!==0){attendee.splice(0);}if(attendee.length!==0){attendee.splice(0);}$('#peoplelistcheckboxes :checkbox').each(function(){namelist.push($(this).attr('name'));if($(this).is(':checked')){attendee.push($(this).attr('name'));}});}$(document).on('pagecreate','#homePage',function(){"use strict";debugmode=($('#debugMode').length!==0);submitter=localStorageGetItem('submitter');showSubmitter=localStorageGetItem('showSubmitter');if(showSubmitter===null){showSubmitter=1;}$('#billamountinput').keyup(function(){if($(this).attr('type')==='text'){var val=$(this).val().toString();$(this).val(formatMoney(val));}});$('#billamountinput').blur(function(){billAmount=$(this).val();calculate_using_billAmount(billAmount,attendee.length);drawAllAmountsText();$('#submitButton').button('enable');});$('#billamountinput').focus(function(){$(this).val('');});$('#tipsminus').click(function(){if(amountToTip>=0.25){amountToTip-=0.25;amountToPay-=0.25;lunchFundAmount+=0.25;drawAllAmountsText();}});$('#tipsplus').click(function(){if(lunchFundAmount>=0.25){amountToTip+=0.25;amountToPay+=0.25;lunchFundAmount-=0.25;drawAllAmountsText();}});$('#eachpayminus').click(function(){if(lunchFundAmount>attendee.length){eachPays-=1.00;lunchFundAmount-=attendee.length;drawAllAmountsText();}});$('#eachpayplus').click(function(){eachPays+=1.00;lunchFundAmount+=attendee.length;drawAllAmountsText();});$('#submitterselect').change(function(){if($(this).val()!==''){submitter=$(this).val();localStorageSetItem('submitter',submitter);}});$('#submissionForm').submit(function(event){if(syncSubmissionForm()){$.post('php/dbAddEvent.php',$(this).serialize(),function(data){if(data.status==='success'){document.getElementById('tadaAudio').play();postFormToGoogle();alert("Submitted Successfully");$('#submitButton').button('disable');}else{if(debugmode){console.log(data.status);console.log(data.message);}alert('ERROR: '+data.message);}},'json');}event.preventDefault();});});$(document).on('pageinit','#homePage',function(){"use strict";if(navigator.userAgent.match(/(iPod|iPhone|iPad)/i)){var numInput=document.getElementById('billamountinput');numInput.setAttribute('type','text');}initAttendeeList();drawParticipantText();drawAllAmountsText();drawSelectMenu($('#fundholderselect'),attendee,getLunchFundHolder());drawSelectMenu($('#submitterselect'),attendee,submitter);drawSubmissionFormChkBox($("#submissionforminput"));});$(document).on('pageshow','#homePage',function(){"use strict";if(showSubmitter===0){$('#submitterfield').hide();}else{$('#submitterfield').show();}if(attendeeChanged===true){drawParticipantText();calculate_using_billAmount(billAmount,attendee.length);drawAllAmountsText();drawSelectMenu($('#fundholderselect'),attendee,getLunchFundHolder());drawSelectMenu($('#submitterselect'),attendee,submitter);attendeeChanged=false;}});$(document).on('pagecreate','#peoplePage',function(){"use strict";$('#peoplelistcheckboxes input:checkbox').change(function(){attendeeChanged=true;});$('#peopletomainbutton').click(function(){if(attendeeChanged===true){if(attendee.length!==0){attendee.splice(0);}$('#peoplelistcheckboxes input:checked').each(function(){attendee.push($(this).attr('name'));});}});});$(document).on('pageinit','#peoplePage',function(){"use strict";});$(document).on('pagecreate','#settingsPage',function(){"use strict";$('#clearlocalstoragebutton').click(function(){localStorage.clear();alert('Local Storage Removed, You must restart the app now');});$('#refreshdatabutton').click(function(){jsonReadGoogleSpreadsheet(function(){alert('Google data refreshed on '+localStorageGetItem('timeofstat'));});});$('#showsubmitterchkbox').change(function(){if($(this).is(':checked')){showSubmitter=1;}else{showSubmitter=0;}localStorageSetItem('showSubmitter',showSubmitter);});});$(document).on('pageinit','#settingsPage',function(){"use strict";$("#eventdate").attr('value',getDate());if(!Modernizr.localstorage){$('#clearlocalstoragebutton').addClass('ui-disabled');$('#showsubmitterchkbox').checkboxradio('disable');}$('#showsubmitterchkbox').attr("checked",showSubmitter===1?true:false).checkboxradio("refresh");});$(document).on('pageshow','#settingsPage',function(){"use strict";if(Modernizr.localstorage){if(submitter===null){$('#showsubmitterchkbox').checkboxradio('disable');}else{$('#showsubmitterchkbox').checkboxradio('enable');}}});$(document).on('pagecreate','#summaryPage',function(){"use strict";$("#fundbookvaluetext").text(" .. refreshing .. ");});$(document).on('pageshow','#summaryPage',function(){"use strict";var share=JSON.parse(localStorageGetItem('share')),fund_bookvalue=localStorageGetItem('fund_bookvalue'),fund_marketvalue=localStorageGetItem('fund_marketvalue'),total_shares=localStorageGetItem('total_shares'),submitter_share,submitter_shareratio,fundvalue,submitter_sharevalue;$('#timeofstat').text(localStorageGetItem('timeofstat'));$("#fundbookvaluetext").text(fund_bookvalue);$("#fundmarketvaluetext").text(fund_marketvalue);if(submitter===null){$('#submittersharetext').text('Specify Submitter');$('#submittersharevaluetext').text('N/A');}else{submitter_share=parseFloat(share[submitter]);submitter_shareratio=submitter_share/total_shares;fundvalue=parseFloat(fund_marketvalue.substr(1));submitter_sharevalue=fundvalue*submitter_shareratio;$('#submittersharetext').text(submitter_share.toFixed(2));$('#submittersharevaluetext').text('$'+submitter_sharevalue.toFixed(2));}if(share===null){$("#fundbookvaluetext").text('Go to Settings Page');$("#fundmarketvaluetext").text('And Refresh Data from Google');}else{drawPieChart(attendee,share);}});