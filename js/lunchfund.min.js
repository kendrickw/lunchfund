var namelist=null;var share=null;var fund_bookvalue=0;var total_shares=0;var attendee=null;var submitter;var showSubmitter;var tipPercent=10;var billAmount=0;var amountToTip=0;var amountToPay=0;var eachPays=0;var lunchFundAmount=0;var attendeeChanged=false;function localStorageSetItem(name,value){"use strict";if(Modernizr.localstorage){localStorage.setItem(name,value);}}function localStorageGetItem(name){"use strict";if(Modernizr.localstorage){return localStorage.getItem(name);}else{return null;}}function getDate(){"use strict";var now=new Date();return now.getFullYear()+'-'+(now.getMonth()+1)+'-'+now.getDate();}var google_form_input_name="entry.598889479";var google_form_input_id_pfx="gform_";var google_form_lunchfund_id="entry_1892695599";var google_form_whoholdsmoney_id="entry_960282559";var google_form_submittername_id="entry_1745174688";var google_form_eventdate_id="entry_472715279";function drawGoogleFormChkBox(element){"use strict";var chkboxlist="",i=0,len=namelist.length;while(i<len){chkboxlist+='<input type="checkbox" style="display:none;"'+' name="'+google_form_input_name+'"'+' value="'+namelist[i]+'"'+' id="'+google_form_input_id_pfx+i+'"/>\n';i+=1;}element.empty();element.append(chkboxlist);}function drawAppFormChkBox(element){"use strict";var chkboxlist="",i=0,len=namelist.length,name="";while(i<len){name=namelist[i];chkboxlist+='<input type="checkbox"'+' id="chkbox_'+i+'"'+' name="'+name+'"';if($.inArray(name,attendee)!==-1){chkboxlist+=' checked="checked"';}chkboxlist+='/>\n'+'<label for="chkbox_'+i+'">'+name+'</label>\n';i+=1;}element.empty();element.append(chkboxlist);element.parent().trigger('create');}function drawSelectMenu(selectelement,selectlist,selected){"use strict";var optionlist="<option value='' data-placeholder='true'>Choose one</option>\n",i=0,len=selectlist.length,name="";while(i<len){name=selectlist[i];optionlist+='<option value="'+name+'"';if(selected===name){optionlist+=' selected="selected"';}optionlist+='>'+name+'</option>\n';i+=1;}selectelement.empty();selectelement.append(optionlist);selectelement.selectmenu('refresh');}function getLunchFundHolder(){"use strict";var fundholder=$('#fundholderselect').val();if(fundholder!==""){return fundholder;}else{return null;}}function getSubmitter(){"use strict";var submittername=$('#submitterselect').val();if(submittername!==""){return submittername;}else{return null;}}function getEventDate(){"use strict";var date=$('#eventdate').val();if(date===''){return getDate();}else{return date;}}function drawParticipantText(){"use strict";var selected=attendee.slice(),num=selected.length,listverbosetext;if(num===0){listverbosetext="No Luncher";}else{listverbosetext=selected.join(", ");}$("#participantcounttext").text(num);$("#participantlisttext").text(listverbosetext);}function syncGoogleCheckboxes(){"use strict";var i=0,len=namelist.length,name="",input_idname="",input_elem;while(i<len){name=namelist[i];input_idname=google_form_input_id_pfx+i;input_elem=$("#"+input_idname);if($.inArray(name,attendee)!==-1){input_elem.attr('checked','checked');}else{input_elem.removeAttr('checked');}i+=1;}}function syncGoogleLunchFundAmount(){"use strict";var element=$("#"+google_form_lunchfund_id);element.attr('value',lunchFundAmount);}function syncGoogleWhoHoldsMoney(){"use strict";var element=$("#"+google_form_whoholdsmoney_id);element.attr('value',getLunchFundHolder());}function syncGoogleSubmitterName(){"use strict";var element=$("#"+google_form_submittername_id);element.attr('value',submitter);}function syncGoogleEventDate(){"use strict";var element=$("#"+google_form_eventdate_id);element.attr('value',getEventDate());}function syncGoogleForm(){"use strict";if(attendee.length===0){alert("You must select at least one luncher.");return false;}if(billAmount<=0){alert("You must provide a non-zero bill amount.");return false;}if(getLunchFundHolder()===null){alert("You must select a lunch fund holder.");return false;}if(getSubmitter()===null){alert("You must select a submitter name.");return false;}syncGoogleCheckboxes();syncGoogleLunchFundAmount();syncGoogleWhoHoldsMoney();syncGoogleSubmitterName();syncGoogleEventDate();$.mobile.loading('show');return true;}function submittedGoogleForm(){"use strict";$.mobile.loading('hide');alert("Submitted to Google Doc successfully.");}function calculate_using_billAmount(billamount,numPerson){"use strict";var totalCollected;amountToPay=Math.ceil(billAmount*(1+tipPercent/100));amountToTip=amountToPay-billAmount;if(numPerson>0){eachPays=Math.ceil(amountToPay/numPerson);}else{eachPays=0;}totalCollected=eachPays*numPerson;lunchFundAmount=totalCollected-amountToPay;}function calculate_actual_tip_percentage(billamount,tipsamount){"use strict";if(billamount===0){return 0;}else{return(tipsamount/billamount*100).toFixed(2);}}function drawAllAmountsText(){"use strict";$("#tipspercenttext").text(calculate_actual_tip_percentage(billAmount,amountToTip));$("#tipstext1").text(amountToTip).formatCurrency();$("#tipstext2").text(amountToTip).formatCurrency();$("#mealtotaltext").text(amountToPay).formatCurrency();$("#eachpaystext1").text(eachPays).formatCurrency();$("#eachpaystext2").text(eachPays).formatCurrency();$("#lunchfundtext").text(lunchFundAmount).formatCurrency();}function formatMoney(val){"use strict";var regex=/[0-9]/,len=0;if(!regex.test(val[val.length-1])){val=val.slice(0,-1);}val=val.replace(".","");while(val.length>1){if(val[0]==='0'){val=val.substr(1);}else{break;}}if(val.length===0){val="0.00";}else if(val.length===1){val="0.0"+val;}else if(val.length===2){val="0."+val;}else{len=val.length;val=val.substr(0,len-2)+"."+val.substr(len-2);}return val;}function drawPieChart(inputnamelist){"use strict";$(function(){var piechart_data=[],count=inputnamelist.length,j=0,plot;piechart_data[count]={label:"Others",data:0};$.each(namelist,function(i,name){if($.inArray(name,inputnamelist)!==-1){piechart_data[j]={label:name,data:parseInt(share[name],10)};j+=1;}else{piechart_data[count].data+=parseInt(share[name],10);}});plot=$.plot($("#piechart1"),piechart_data,{series:{pie:{show:true,radius:1,label:{show:true,radius:3/4,formatter:function(label,series){return'<div style="font-size:8pt;text-align:center;padding:2px;color:black;">'+label+'<br/>'+Math.round(series.percent)+'%</div>';}}}},legend:{show:false}});});}function jsonReadGoogleSpreadsheet(callbackfunc){"use strict";$.mobile.loading('show');$.getJSON("https://spreadsheets.google.com/feeds/cells/0Av83aWCuOImRdDA5cFVBd2hlbnhvYnhkQmJMNUhHYXc/od7/public/basic?alt=json-in-script&callback=?",function(data){var owner_row=0,shares_row=0,bookvalue_row=0,totalshare_row=0,name_idx,cell,value;namelist=[];share={};fund_bookvalue=0;total_shares=0;$.each(data.feed.entry,function(i,entry){cell=entry.title.$t;value=entry.content.$t;if(cell[0]==='A'){if(bookvalue_row===0&&value==='Current Fund Book Value'){bookvalue_row=cell.substr(1);}else if(totalshare_row===0&&value==='Total outstanding shares'){totalshare_row=cell.substr(1);}else if(owner_row===0&&value==='Owner'){owner_row=cell.substr(1);}else if(shares_row===0&&value==='Number of Shares'){shares_row=cell.substr(1);name_idx=0;}}else{if(cell.substr(1)===bookvalue_row){fund_bookvalue=value;}else if(cell.substr(1)===totalshare_row){total_shares=value;}else if(cell.substr(1)===owner_row){namelist.push(value);}else if(cell.substr(1)===shares_row){share[namelist[name_idx]]=value;name_idx+=1;}}});localStorageSetItem('timeofstat',Date());namelist.sort(function(a,b){var a1=parseFloat(share[a]),b1=parseFloat(share[b]);if(a1===b1){return 0;}return a1<b1?1:-1;});localStorageSetItem('namelist',JSON.stringify(namelist));localStorageSetItem('share',JSON.stringify(share));localStorageSetItem('fund_bookvalue',fund_bookvalue);localStorageSetItem('total_shares',total_shares);$.mobile.loading('hide');callbackfunc();});}function initAttendeeList(){"use strict";if(attendee===null){attendee=JSON.parse(localStorageGetItem('attendee'));}if(attendee===null){attendee=[];var i=0,len=namelist.length;if(len>5){len=5;}while(i<len){attendee.push(namelist[i]);i+=1;}localStorageSetItem('attendee',JSON.stringify(attendee));}}$(document).on('pagecreate','#homePage',function(){"use strict";submitter=localStorageGetItem('submitter');showSubmitter=localStorageGetItem('showSubmitter');if(showSubmitter===null){showSubmitter=1;}share=JSON.parse(localStorageGetItem('share'));fund_bookvalue=localStorageGetItem('fund_bookvalue');total_shares=localStorageGetItem('total_shares');if(namelist===null){namelist=JSON.parse(localStorageGetItem('namelist'));}$('#billamountinput').keyup(function(){if($(this).attr('type')==='text'){var val=$(this).val().toString();$(this).val(formatMoney(val));}});$('#billamountinput').blur(function(){billAmount=$(this).val();calculate_using_billAmount(billAmount,attendee.length);drawAllAmountsText();});$('#billamountinput').focus(function(){$(this).val('');});$('#tipsminus').click(function(){if(amountToTip>=0.25){amountToTip-=0.25;amountToPay-=0.25;lunchFundAmount+=0.25;drawAllAmountsText();}});$('#tipsplus').click(function(){if(lunchFundAmount>=0.25){amountToTip+=0.25;amountToPay+=0.25;lunchFundAmount-=0.25;drawAllAmountsText();}});$('#eachpayminus').click(function(){if(lunchFundAmount>attendee.length){eachPays-=1.00;lunchFundAmount-=attendee.length;drawAllAmountsText();}});$('#eachpayplus').click(function(){eachPays+=1.00;lunchFundAmount+=attendee.length;drawAllAmountsText();});$('#submitterselect').change(function(){if($(this).val()!==''){submitter=$(this).val();localStorageSetItem('submitter',submitter);}});});$(document).on('pageinit','#homePage',function(){"use strict";if(navigator.userAgent.match(/(iPod|iPhone|iPad)/i)){var numInput=document.getElementById('billamountinput');numInput.setAttribute('type','text');}if(namelist===null){$("#participantcounttext").text(0);$("#participantlisttext").text(".. Refreshing List ..");jsonReadGoogleSpreadsheet(function(){initAttendeeList();drawParticipantText();calculate_using_billAmount(billAmount,attendee.length);drawAllAmountsText();drawSelectMenu($('#fundholderselect'),attendee,getLunchFundHolder());drawSelectMenu($('#submitterselect'),attendee,submitter);drawGoogleFormChkBox($("#googleforminput"));});}else{initAttendeeList();drawParticipantText();calculate_using_billAmount(billAmount,attendee.length);drawAllAmountsText();drawSelectMenu($('#fundholderselect'),attendee,getLunchFundHolder());drawSelectMenu($('#submitterselect'),attendee,submitter);drawGoogleFormChkBox($("#googleforminput"));}});$(document).on('pageshow','#homePage',function(){"use strict";if(showSubmitter===0){$('#submitterfield').hide();}else{$('#submitterfield').show();}if(attendeeChanged===true){localStorageSetItem('attendee',JSON.stringify(attendee));drawParticipantText();calculate_using_billAmount(billAmount,attendee.length);drawAllAmountsText();drawSelectMenu($('#fundholderselect'),attendee,getLunchFundHolder());drawSelectMenu($('#submitterselect'),attendee,submitter);attendeeChanged=false;}});$(document).on('pagecreate','#peoplePage',function(){"use strict";});$(document).on('pageinit','#peoplePage',function(){"use strict";drawAppFormChkBox($("#peoplelistcheckboxes"));$('#peoplelistcheckboxes input:checkbox').change(function(){attendeeChanged=true;});$('#peopletomainbutton').click(function(){if(attendeeChanged===true){if(attendee.length!==0){attendee.splice(0);}$('#peoplelistcheckboxes input:checked').each(function(){attendee.push($(this).attr('name'));});}});});$(document).on('pagecreate','#settingsPage',function(){"use strict";$('#clearlocalstoragebutton').click(function(){localStorage.removeItem('submitter');localStorage.removeItem('showSubmitter');localStorage.removeItem('attendee');localStorage.removeItem('namelist');localStorage.removeItem('share');localStorage.removeItem('fund_bookvalue');localStorage.removeItem('total_shares');localStorage.removeItem('timeofstat');alert('Local Storage Removed, You must restart the app now');});$('#refreshdatabutton').click(function(){jsonReadGoogleSpreadsheet(function(){alert('Google data refreshed on '+localStorageGetItem('timeofstat'));});});$('#showsubmitterchkbox').change(function(){if($(this).is(':checked')){showSubmitter=1;}else{showSubmitter=0;}localStorageSetItem('showSubmitter',showSubmitter);});});$(document).on('pageinit','#settingsPage',function(){"use strict";$("#eventdate").attr('value',getDate());if(!Modernizr.localstorage){$('#clearlocalstoragebutton').addClass('ui-disabled');$('#showsubmitterchkbox').checkboxradio('disable');}$('#showsubmitterchkbox').attr("checked",showSubmitter===1?true:false).checkboxradio("refresh");});$(document).on('pageshow','#settingsPage',function(){"use strict";if(Modernizr.localstorage){if(submitter===null){$('#showsubmitterchkbox').checkboxradio('disable');}else{$('#showsubmitterchkbox').checkboxradio('enable');}}});$(document).on('pagecreate','#summaryPage',function(){"use strict";$("#fundvaluetext").text(" .. refreshing .. ");});$(document).on('pageshow','#summaryPage',function(){"use strict";$('#timeofstat').text(localStorageGetItem('timeofstat'));$("#fundvaluetext").text(fund_bookvalue);if(submitter===null){$('#submittersharetext').text('Specify Submitter');$('#submittersharevaluetext').text('N/A');}else{var submitter_share=parseFloat(share[submitter]),submitter_shareratio=submitter_share/total_shares,fundvalue=parseFloat(fund_bookvalue.substr(1)),submitter_sharevalue=fundvalue*submitter_shareratio;$('#submittersharetext').text(submitter_share.toFixed(2));$('#submittersharevaluetext').text('$'+submitter_sharevalue.toFixed(2));}drawPieChart(attendee);});
